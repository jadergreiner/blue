# Aula 20 - \[AULA] Introdu√ß√£o ao Pandas - Parte 3

## Conte√∫dos

* Criar novas colunas a partir de colunas existentes
* Renomar colunas
* Calculando estat√≠sticas
* Agregar estat√≠stica por categoria (group by)
* Contar registros por categoria
* Reordenando o layout das tabelas
* Criando novos dataframes com filtro de dados


## Criar novas colunas a partir de colunas existentes

Importando a biblioteca pandas

~~~
import pandas as pd
~~~

Usaremos o mesmo dataset da √∫ltima aula, sobre a qualidade do ar.

~~~
air_quality = pd.read_csv("air_quality_no2.csv", index_col=0, parse_dates=True)
air_quality.head()
~~~

Vamos incluir a informa√ß√£o da concentra√ß√£o de ar em mg/m em Londres‚ùó

Se assumirmos temperatura de 25 graus Celsius e press√£o de 1013 hPa, o fator de convers√£o √© de 1.882

~~~
air_quality["london_mg_per_cubic"] = air_quality["station_london"] * 1.882
air_quality.head()
~~~

:pushpin: Para criar uma nova coluna, use os colchetes com o nome da nova coluna antes da atribui√ß√£o ("=").

O c√°lculo dos valores utiliza **element_wise**. Isso significa que todos os valores da coluna dada s√£o multiplicados pelo valor 1.882 de uma s√≥ vez. Voc√™ n√£o precisa usar um loop para iterar cada uma das linhas!

Agora vamos analisar a proporta√ß√£o dos valores entre Paris e Antwerp, salvando o resultado em uma nova coluna.

~~~
air_quality["ratio_paris_antwerp"] = (
    air_quality["station_paris"] / air_quality["station_antwerp"]
)

air_quality.head()
~~~

Novamente usamos o **element_wise**, calculando a divis√£o sobre duas colunas.

Imagino que j√° tenha percebido o potencial desta biblioteca! Podemos usar os operadores matem√°ticos (+, -, *, /) ou operadores l√≥gicos (<, >, =, ...) junto com express√µes condicionais. Fica o convite para brincar um pouco üòâ

Como um material complementar, se precisar de algo mais avan√ßado, pode usar o arbitrary Python com <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.apply.html#pandas.DataFrame.apply" target="_blank"><code>apply()</code> </a>.

## Renomar colunas

Vamos renomar as colunas com os identificadores de esta√ß√£o correspondentes utilizados pelo openAQ

~~~
air_quality_renamed = air_quality.rename(
    columns={
        "station_antwerp": "BETR801",
        "station_paris": "FR04014",
        "station_london": "London Westminster",
    }
)

air_quality_renamed.head()
~~~

A fun√ß√£o <code>rename()</code> pode ser usada para renomear nome de linhas ou colunas. Sua sintaxe funciona atrav√©s de um dicion√°rio(chave-valor), informamos o nome atual na chave o novo nome como valor.

O mapeamento n√£o est√° restrito apenas a nomes fixos, mas tamb√©m pode ser uma fun√ß√£o. Por exemplo, a convers√£o dos nomes das colunas em letras min√∫sculas tamb√©m pode ser feita usando uma fun√ß√£o:

~~~
air_quality_renamed = air_quality_renamed.rename(columns=str.lower)

air_quality_renamed.head()
~~~

:point_right: Material complementar sobre a renomea√ß√£o de r√≥tulos de coluna ou linha na documenta√ß√£o oficial https://pandas.pydata.org/pandas-docs/stable/user_guide/basics.html#basics-rename

## Calculando estat√≠sticas

Para melhorar nossa did√°tica e compreens√£o, vamos retomar a an√°lise em nosso dataframe Titanic.


~~~
titanic = pd.read_csv("data/titanic.csv")

titanic.head()
~~~

Qual a idade m√©dia dos passageiros ‚ùì

~~~
titanic["Age"].mean()
~~~

Diversas estat√≠sticas est√£o dispon√≠veis e podem ser aplicadas em colunas com dados num√©ricos. As opera√ß√µes em geral excluem dados perdidos e operam em linhas por padr√£o.

Qual a idade m√©dia dos passageiros e qual o valor m√©dio das tarifas?

~~~
titanic[["Age", "Fare"]].median()
~~~

üìå Ao aplicar estat√≠stica a v√°rias colunas, o resultado retorna um objeto DataFrame.

Podemos calcular estat√≠sticas sumarizadas para v√°rias colunas ao mesmo tempo. Lembra-se do <code>describe()</code> que olhamos nas primriras aulas.

~~~
titanic[["Age", "Fare"]].describe()
~~~

E podemos customizar nossas estat√≠sicas. Ao inv√©s de usar as pr√©-definidas, podemos agregar combina√ß√µes espec√≠ficas usando o m√©todo <code>agg()</code>

~~~
titanic.agg(
    {
        "Age": ["min", "max", "median", "skew"],
        "Fare": ["min", "max", "median", "mean"],
    }
)
~~~

Material complementar de estat√≠stica descritiva ‚û°Ô∏è https://pandas.pydata.org/pandas-docs/stable/user_guide/basics.html#basics-stats

## Agregar estat√≠stica por categoria (group by)

Qual a idade m√©dia dos passageiros femininos e masculinos do Tinanic ‚ùì

Sim, eu sei que voc√™ j√° sabe calcular individualizado! Mas quero te apresentar a agrega√ß√£o de resultados do Pandas ‚ùó

~~~
titanic[["Sex", "Age"]].groupby("Sex").mean()
~~~

Como desejamos a idade m√©dia de cada g√™nero, primeiro montamos um subconjunto com estas duas colunas. Ap√≥s, o m√©todo <code>groupby()</code> √© aplicado na coluna para fazer um grupo por categoria de forma autom√°tica. N√£o importa o n√∫mero de categorias, o m√©todo vai criar um novo agrupamento cada vez que encontrar um novo r√≥tulo. 


Vamos ver outras formas bem interessantes de olhar os dados agrupados. 
Vamos agrupar os dados antes e depois vamos aplicar uma estat√≠stica neles.

~~~
titanic.groupby("Sex").mean()
~~~

Mas se quisermos a m√©dia de idade dos passageiros por sexo, podemos filtar com os colchetes ap√≥s a agrega√ß√£o.

~~~
titanic.groupby("Sex")["Age"].mean()
~~~

Percebeu que o resultado √© o mesmo que realizamos antes? Qual a forma correta?

Fica para discuss√£o em aula. Quero ouvir sua opini√£o!

Um dos p√°peis de an√°lise de dados √© interpretar os dados. Concorda que n√£o faz muito sentido obter uma m√©dia da coluna <code>Pclass[]</code> ‚ùì

A coluna cont√©m dados num√©ricos, mas na verdade representa 3 categorias (ou fatores) com, respectivamente, os r√≥tulos '1', '2' e '3'. Calcular estat√≠sticas sobre isso n√£o faz muito sentido. Portanto, o pandas fornece um tipo de dados para lidar com esse tipo de dados. 
Dica de material complementar sobre dados categ√≥ricos https://pandas.pydata.org/pandas-docs/stable/user_guide/categorical.html#categorical

Agora assim! Qual √© o pre√ßo m√©dio da passagem para cada uma das combina√ß√µes de sexo e classe por cabine?

~~~
titanic.groupby(["Sex", "Pclass"])["Fare"].mean()
~~~

Agora fez mais sentido trazer a cabine para a an√°lise. O agrupamento pode ser feito com v√°rias colunas ao mesmo tempo. Informe o nome das colunas como uma lista no <code>groupby()</code> .

## Contar registros por categoria

Qual o n√∫mero de passageiros em cada uma das classes ‚ùì

~~~
titanic["Pclass"].value_counts()
~~~

O m√©todo <code>value_counts()</code> conta o n√∫mero de registros de cada categoria em uma coluna.

A fun√ß√£o √© um atalho. Ela faz uma opera√ß√£o de agrega√ß√£o e combina com a contagem do n√∫mero de registros dentro do grupo

~~~
titanic.groupby("Pclass")["Pclass"].count()
~~~

## Reordenando o layout das tabelas

Vamos classificar os dados do Titanic de acordo com a idade dos passageiros

~~~
titanic.sort_values(by="Age").head()
~~~

Vamos classificar os dados de acordo com a Classe da Cabine e a idade em ordem descrecente

~~~
titanic.sort_values(by=['Pclass', 'Age'], ascending=False).head()
~~~

Para saber mais sobre a ordena√ß√£o de dados, visite a documenta√ß√£o https://pandas.pydata.org/pandas-docs/stable/user_guide/basics.html#basics-sorting

## Criando novos dataframes com filtro de dados

Voltamos ao dataset de qualidade do ar ‚ùó

Vamos criar um pequeno subconjunto do conjunto de dados de qualidade do ar. Vamos filtar os dados de NO2 e apenas as duas primeiras medi√ß√µes de cada local. O subconjunto de dados ser√° chamado no2_subset


